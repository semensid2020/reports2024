# Задание
```
Задание 1: Улучшение аналитики
У вас есть модель Order с атрибутами:
id — уникальный идентификатор заказа,
amount — сумма заказа,
created_at — дата создания.

Задача:
Написать метод для подсчета общей суммы заказов по месяцам за последний год.
Реализовать тесты для проверки корректности работы метода.
Оптимизировать запросы к базе данных, чтобы минимизировать их количество.



Задание 2: Перемещение и загрузка файлов
Реализуйте функциональность для перемещения файлов с одного сервера на другой и последующей загрузки их в облачное хранилище.

Требования:
Написать сервисный объект, который:
Загружает файл с удаленного сервера через SFTP или HTTP.
Сохраняет его временно локально.
Загружает его в облачное хранилище (например, AWS S3, Google Cloud Storage, или другое).
Реализовать валидацию файлов (проверка формата и размера).
Написать тесты для проверки корректной работы сервиса.



Задание 3: Асинхронные задачи
Реализовать функциональность для автоматической отправки ежемесячного отчета пользователям.

Требования:
Создайте задачу, которая генерирует отчет о заказах пользователя за месяц в виде PDF.
Настройте отправку этого отчета по электронной почте.
Реализуйте асинхронное выполнение задачи с помощью Sidekiq или Delayed Job.
Напишите тесты для проверки работы задачи.
К тестовому нужно приложить:



Код решений.
Инструкции по настройке окружения (если используются дополнительные гемы).
Краткое описание каждого решения: подходы, трудности, оптимизация.
```


# Системные требования
```
ruby 3.3.1
rails >= 7.0.8.7
PostgreSQL (не ниже 12, лучше 14 и выше)
Redis
Mailcather
```


# Разворот проекта
```
В папке проекта выполнить в терминале:
bundle install

В папке проекта на основании файла ./config/database.yml.example создать файл ./config/database.yml

Далее выполнить:
sudo -u postgres psql


В открывшейся консоли PostgreSQL выполнить:
CREATE USER reports2024 WITH PASSWORD 'reports2024' CREATEDB;
CREATE DATABASE reports2024_development OWNER reports2024; (опционально)

далее нужно выйти, нажав ctrl + D

В папке проекта выполнить в терминале:
rails db:create (опционально. Нужно только если не была выполнена предыдущая команда на создание БД)
rails db:migrate
rails db:seed   (опционально, но необходимо для проверки некоторых заданий, например 1)
```

## Запуск проекта
```
В одном окне:   bundle exec rails server
В другом окне:  bundle exec sidekiq -q default (опционально, нужно только для демонстрации задания №3)
В третьем окне: bundle exec sidekiq -q mailers (опционально, нужно только для демонстрации задания №3)

Проект доступен по урлу:
http://localhost:3005/


Аккаунты для входа:
user1@example.com
password

user2@example.com
password

admin@example.com
password

(ролевая модель не реализована, все пользователи с одинаковыми правами. Лучше использовать user1 или user2)
```

# Дополнительная информация:
1. Запуск тестов командой bundle exec rspec


## Комментарии по полученным результатам
```
Задание 1.

Запрашиваемый в задании метод может быть вызван выполнением GET-запроса на эндпоинт:
http://localhost:3005/api/last_year_by_months

Для удобства проверки в веб-интерфейсе добавлена синяя кнопка: "Last 12 months (by months)"

В ходе выполнения размышлял на тем, использовать ли гем 'groupdate',
предоставлящий метод удобный orders.group_by_month(...).
Однако, всё же решил собрать запрос вручную, тем более что итоговый SQL
почти идентичный тому, что генерирует вышеупомянутый метод.
SQL выглядит эффективным, забирает необходимые данные за 1 запрос к БД.

Так же пришлось потратить некоторое время чтобы корректно подсчитать количество дней,
которые нужно вычесть в случае високосного года (текущего или предыдущего).
Это показалось важным (не в рамках текущей задачи, а в целом), поэтому этому было уделено повышенное внимание.
Так же можно добавить пагинацию - на случай большого количества записей
(если будет необходимость свериться с общим количеством заказов (Order)).


Задание 2.

Значительно время пришлось потратить на поиски подходящего сервиса для тестирования загрузки/скачивания файлов.
За адекватное время идеально подходящий сервис, доступный из страны проживания (и имеющий бесплатное/открытое API),так и не был найден.
Был использован сервис File.io, имеющий одну особенность - после скачивания файла (единовременного), сервис данный файл удаляет.

Поэтому пришлось ограничиться проверкой метаданных о файле без его непосредственного скачивания, что отразилось на коде.
Так, изначально FileDownloadService планировался для запуска в 2 режимах - первичное скачивание файла с выбранного юзерам URL-а,
а также режим повторного скачивания уже с File.io - с целью полной проверки юзкейса со скачиванием по сгенерированному и отданномму сервисом File.io URL-у.

Так же изначально реализовывал с помощью ActiveStorage, однако с его использованием возникла некая проблема с передачей в заголовках типа данных,
поэтому от него отказался в пользу Carrierwave.

Итоговый порядок возникновения событий (упрощенно) следующий :
- Скачивание с предоставленного юзерам адреса файла и сохранение его локально
- Загрузка на сервис File.io, получение в ответе ссылки на файл (на данном сервисе)
- Проверка, что наш файл, хранящийся локально, соотвествует файлу на File.io


Что не успел реализовать/стоит улучшить:
- Удаление по определенному расписанию файлов (например, после 30 дней их хранения локально)
- Более тщательная обработка ошибок. Более обширные и качественные автотесты;
- Найти подходящий сервис (вместо File.io);
- Есть понимание, что часть кода можно повыносить в отдельные модули/хэлперы, что BASE_URI в сервисе FileUploadService стоило вынести в .env и т.д.

В целом задание №2 считаю реализовано неплохо, однако оно заняло большую часть времени, поэтому на задание №3 времени осталось очень немного.
Вероятно, моя это ошибка планирования времени.


Задание 3.

Не успел реализовать весь запрашиваемый функционал, однако удалось пописать сервисные объекты, джобы, как-то прописать их логику вызова,
т.к. необходимо было продемонстрировать понимание данных процессов.
Чего не хватает:
- обработки ошибок, граничных значений;
- автотестов (для данной функциональности их нет совсем);
- не успел реализовать до конца отправку по почте;
- в целом реализация, конечно, нуждается в доработке.


```
